<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Podrutos</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
    <script src='main.js'></script>
</head>

<body>
    <h1>Listagem de Produtos</h1>   
            <form>
                <label>ID: </label>
                <input type="text" id="tx_id" disabled="disabled" readonly="readonly"/>
                <br><br>
                <label>Descrição: </label>
                <input type="text" id="tx_descricao"/>
                <br><br>
                <label>Quantidade em Estoque: </label>
                <input type="number" id="dbl_quantidade_estoque" step="0.01"/>
                <br><br>
                <label>Preço por Unidade: </label>
                <input type="number" id="nu_preco_unidade_atual" step="0.01"/>
                <br><br>
                <label>Ativo: </label>
                <input type="checkbox" id="bo_ativo"/>
                <br><br>
                <button type="button" onclick="criarProduto()">Criar</button>
                <button type="button" onclick="alterarProduto()">Alterar</button>
                <button type="button" onclick="carregarProdutos()">Listar</button>
                <button type="button" onclick="limparFormulario()">Limpar</button>
            </form>
            <table border="1" id="listagemProdutos"></table>
        </div>
    </body>

<script>
    function limparFormulario(){
        document.getElementById("tx_id").value = "";
        document.getElementById("tx_descricao").value = "";
        document.getElementById("dbl_quantidade_estoque").value = "";
        document.getElementById("nu_preco_unidade_atual").value = "";
        document.getElementById("bo_ativo").checked = false;
    }

    function alterarProduto(){
       var xhttp = new XMLHttpRequest();
       xhttp.onreadystatechange = function(){
          if(this.readyState == 4 && this.status == 200){
                alert("Produto alterado com sucesso");
                carregarProdutos();
          }
       };
       var produtoData = {
           id: document.getElementById("tx_id").value,
           tx_descricao: document.getElementById("tx_descricao").value,
           dbl_quantidade_estoque: parseFloat(document.getElementById("dbl_quantidade_estoque").value),
           nu_preco_unidade_atual: parseFloat(document.getElementById("nu_preco_unidade_atual").value),
           bo_ativo: document.getElementById("bo_ativo").checked
       };
       xhttp.open("PUT", "/produtos/" + document.getElementById("tx_id").value);
       xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
       xhttp.send(JSON.stringify(produtoData));
    }

    function excluirProduto(id_produto){
       var xhttp = new XMLHttpRequest();
       xhttp.onreadystatechange = function(){
          if(this.readyState == 4 && this.status == 200){
                alert("Produto excluído com sucesso");
                carregarProdutos();
          }
       };
       xhttp.open("DELETE", "/produtos/" + id_produto);
       xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
       xhttp.send();
    }

    function criarProduto(){
       var xhttp = new XMLHttpRequest();
       xhttp.onreadystatechange = function(){
          if(this.readyState == 4 && this.status == 200){
                alert("Produto criado com sucesso");
                carregarProdutos();
          }
       };
       var produtoData = {
           id: null,
           tx_descricao: document.getElementById("tx_descricao").value,
           dbl_quantidade_estoque: parseFloat(document.getElementById("dbl_quantidade_estoque").value),
           nu_preco_unidade_atual: parseFloat(document.getElementById("nu_preco_unidade_atual").value),
           bo_ativo: document.getElementById("bo_ativo").checked
       };
       xhttp.open("POST", "/produtos");
       xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
       xhttp.send(JSON.stringify(produtoData));
    }

    function preencherFormulario(id_produto, descricao, quantidade_estoque, preco_unidade, ativo){
        document.getElementById("tx_id").value = id_produto;
        document.getElementById("tx_descricao").value = descricao;
        document.getElementById("dbl_quantidade_estoque").value = quantidade_estoque;
        document.getElementById("nu_preco_unidade_atual").value = preco_unidade;
        document.getElementById("bo_ativo").checked = ativo;
    }

    function carregarProdutos(){
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function(){
            if(this.readyState == 4 && this.status == 200){
                var dados = JSON.parse(this.responseText); 
                var conteudo ="<tr> <th>ID</th> <th>Descrição</th> <th>Quantidade em Estoque</th> <th>Preço por Unidade</th> <th>Ativo</th> <th>Ações</th> </tr>";        
                for(var produto of dados){
                    conteudo += "<tr>";
                    conteudo += "<td>" + produto.id + "</td>";
                    conteudo += "<td>" + produto.tx_descricao + "</td>";
                    conteudo += "<td>" + produto.dbl_quantidade_estoque + "</td>";
                    conteudo += "<td>" + produto.nu_preco_unidade_atual.toFixed(2) + "</td>";
                    conteudo += "<td>" + (produto.bo_ativo ? 'Sim' : 'Não') + "</td>";
                    conteudo += "<td>";
                    conteudo += "<button type='button' onclick='preencherFormulario(" + produto.id + ", \"" + produto.tx_descricao + "\", " + produto.dbl_quantidade_estoque + ", " + produto.nu_preco_unidade_atual + ", " + produto.bo_ativo + ")'>Alterar</button>";
                    conteudo += "<button type='button' onclick='excluirProduto(" + produto.id + ")'>Excluir</button>";
                    conteudo += "</td>";
                    conteudo += "</tr>";
                }
                document.getElementById("listagemProdutos").innerHTML = conteudo;
                limparFormulario();
            }
        };
        xhttp.open("GET", "/produtos");
        xhttp.send();
    }
    carregarProdutos();
</script>

</html>